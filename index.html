<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Consciousness Monitor — Live Network Coherence</title>
<meta name="description" content="Real-time visualization of the Global Consciousness Project random number generator network. Monitor network coherence, explore historical events, and track the EGG network worldwide.">
<meta name="keywords" content="Global Consciousness Project, GCP, random number generator, network coherence, EGG project, Princeton, noosphere, consciousness research">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-deep:#080b14;
  --bg-card:#0d1117;
  --bg-card-hover:#111820;
  --border:#1b2332;
  --text-primary:#e2e8f0;
  --text-secondary:#8492a6;
  --text-dim:#4a5568;
  --accent-green:#34d399;
  --accent-blue:#60a5fa;
  --accent-cyan:#22d3ee;
  --accent-amber:#fbbf24;
  --accent-red:#f87171;
  --accent-purple:#a78bfa;
  --glow-green:rgba(52,211,153,0.15);
  --glow-blue:rgba(96,165,250,0.1);
}
html{scroll-behavior:smooth}
body{
  font-family:'DM Sans',system-ui,sans-serif;
  background:var(--bg-deep);
  color:var(--text-primary);
  line-height:1.6;
  min-height:100vh;
  overflow-x:hidden;
}
/* Subtle animated background */
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 800px 600px at 20% 20%, rgba(96,165,250,0.03) 0%, transparent 70%),
    radial-gradient(ellipse 600px 800px at 80% 80%, rgba(52,211,153,0.03) 0%, transparent 70%),
    radial-gradient(ellipse 400px 400px at 50% 50%, rgba(167,139,250,0.02) 0%, transparent 70%);
}
.container{max-width:1100px;margin:0 auto;padding:0 24px;position:relative;z-index:1}

/* Header */
header{padding:48px 0 32px;text-align:center}
.site-badge{
  display:inline-flex;align-items:center;gap:8px;
  font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;
  color:var(--accent-cyan);
  background:rgba(34,211,238,0.08);
  border:1px solid rgba(34,211,238,0.15);
  padding:6px 16px;border-radius:20px;
  margin-bottom:20px;
}
.site-badge::before{
  content:'';width:6px;height:6px;border-radius:50%;
  background:var(--accent-cyan);
  box-shadow:0 0 8px var(--accent-cyan);
  animation:pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
h1{
  font-size:clamp(28px,5vw,44px);font-weight:300;letter-spacing:-0.5px;
  margin-bottom:12px;
}
h1 strong{font-weight:700;color:var(--accent-green)}
.subtitle{color:var(--text-secondary);font-size:15px;max-width:600px;margin:0 auto;line-height:1.7}

/* Cards */
.card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:28px;
  transition:border-color 0.3s;
}
.card:hover{border-color:rgba(96,165,250,0.2)}
.card-label{
  font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--text-dim);margin-bottom:16px;
}

/* Main gauge section */
.gauge-section{
  display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;
  margin:40px 0;
}
.gauge-main{
  grid-column:1/4;
  display:flex;flex-direction:column;align-items:center;
  padding:48px 28px;
}
.gauge-ring{
  position:relative;width:240px;height:240px;margin-bottom:24px;
}
.gauge-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.gauge-track{fill:none;stroke:var(--border);stroke-width:8;stroke-linecap:round}
.gauge-fill{
  fill:none;stroke-width:8;stroke-linecap:round;
  stroke-dasharray:628;stroke-dashoffset:628;
  transition:stroke-dashoffset 2s cubic-bezier(0.4,0,0.2,1),stroke 1s;
  filter:drop-shadow(0 0 12px currentColor);
}
.gauge-center{
  position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
}
.gauge-value{font-family:'Space Mono',monospace;font-size:48px;font-weight:700;line-height:1}
.gauge-unit{font-size:12px;color:var(--text-secondary);margin-top:4px;letter-spacing:1px}
.gauge-status{
  font-size:18px;font-weight:500;margin-bottom:4px;letter-spacing:0.5px;
}
.gauge-description{color:var(--text-secondary);font-size:13px;text-align:center;max-width:340px}
.gauge-updated{
  font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:16px;
}

/* Status levels */
.status-normal{color:var(--accent-blue)}
.status-elevated{color:var(--accent-green)}
.status-high{color:var(--accent-amber)}
.status-very-high{color:var(--accent-red)}

/* Stats row */
.stats-row{
  display:grid;grid-template-columns:repeat(4,1fr);gap:16px;
  margin-bottom:32px;
}
.stat-card{text-align:center;padding:20px 16px}
.stat-value{
  font-family:'Space Mono',monospace;font-size:28px;font-weight:700;
  margin-bottom:4px;
}
.stat-label{font-size:12px;color:var(--text-secondary)}

/* Timeline chart */
.timeline-section{margin-bottom:32px}
.chart-container{position:relative;height:220px;margin-top:16px}
canvas{width:100%!important;height:100%!important}
.chart-legend{
  display:flex;gap:20px;justify-content:center;margin-top:12px;
  font-size:12px;color:var(--text-secondary);
}
.chart-legend span{display:flex;align-items:center;gap:6px}
.legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block}

/* World map */
.map-section{margin-bottom:32px}
.map-container{
  position:relative;width:100%;aspect-ratio:2/1;
  background:var(--bg-deep);border-radius:12px;overflow:hidden;
  margin-top:16px;border:1px solid var(--border);
}
.map-container svg{width:100%;height:100%}
.egg-dot{
  cursor:pointer;transition:r 0.2s;
}
.egg-dot:hover{r:5}
.egg-tooltip{
  position:absolute;background:var(--bg-card);border:1px solid var(--border);
  border-radius:8px;padding:10px 14px;font-size:12px;pointer-events:none;
  opacity:0;transition:opacity 0.2s;z-index:10;white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);
}
.egg-tooltip.visible{opacity:1}
.egg-tooltip .tt-name{font-weight:700;margin-bottom:2px}
.egg-tooltip .tt-stat{color:var(--text-secondary);font-family:'Space Mono',monospace}

/* Events */
.events-section{margin-bottom:32px}
.events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:16px}
.event-card{
  display:flex;gap:16px;align-items:flex-start;
  padding:20px;cursor:default;
}
.event-date{
  font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);
  white-space:nowrap;min-width:80px;padding-top:2px;
}
.event-content{}
.event-name{font-weight:600;font-size:14px;margin-bottom:4px}
.event-desc{font-size:12px;color:var(--text-secondary);line-height:1.5}
.event-z{
  display:inline-block;font-family:'Space Mono',monospace;font-size:11px;
  padding:2px 8px;border-radius:4px;margin-top:6px;
}

/* Explainer */
.explainer-section{margin-bottom:48px}
.explainer-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:20px;margin-top:16px;
}
.explainer-card{padding:24px}
.explainer-card h3{font-size:15px;margin-bottom:8px;color:var(--accent-cyan)}
.explainer-card p{font-size:13px;color:var(--text-secondary);line-height:1.7}

/* Footer */
footer{
  border-top:1px solid var(--border);padding:32px 0;
  text-align:center;color:var(--text-dim);font-size:12px;
}
footer a{color:var(--text-secondary);text-decoration:none;border-bottom:1px solid var(--text-dim)}
footer a:hover{color:var(--accent-cyan);border-color:var(--accent-cyan)}
.footer-links{display:flex;gap:24px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
.sister-link{
  display:inline-flex;align-items:center;gap:6px;
  color:var(--accent-green);font-size:12px;
  border:1px solid rgba(52,211,153,0.2);padding:6px 14px;border-radius:8px;
  text-decoration:none;margin-top:12px;transition:all 0.2s;
}
.sister-link:hover{background:rgba(52,211,153,0.08);border-color:rgba(52,211,153,0.4)}

/* Section titles */
.section-title{
  font-size:20px;font-weight:600;margin-bottom:4px;
}
.section-subtitle{font-size:13px;color:var(--text-secondary)}

/* Loading state */
.loading{
  display:flex;align-items:center;justify-content:center;
  min-height:200px;color:var(--text-dim);
}
.loading::after{
  content:'';width:20px;height:20px;border:2px solid var(--border);
  border-top-color:var(--accent-cyan);border-radius:50%;
  animation:spin 0.8s linear infinite;margin-left:12px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:768px){
  .gauge-section{grid-template-columns:1fr}
  .gauge-main{grid-column:1}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .events-grid{grid-template-columns:1fr}
  .explainer-grid{grid-template-columns:1fr}
  header{padding:32px 0 24px}
  .card{padding:20px}
}
@media(max-width:480px){
  .stats-row{grid-template-columns:1fr 1fr}
  .stat-value{font-size:22px}
  .footer-links{flex-direction:column;align-items:center}
}

/* Animations */
@keyframes fade-up{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fade-up 0.6s ease-out both}
.delay-1{animation-delay:0.1s}
.delay-2{animation-delay:0.2s}
.delay-3{animation-delay:0.3s}
.delay-4{animation-delay:0.4s}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="site-badge">Live Network Data</div>
    <h1>Global <strong>Consciousness</strong> Monitor</h1>
    <p class="subtitle">Real-time visualization of the Global Consciousness Project — a network of random number generators spanning 65+ locations worldwide, maintained by Princeton researchers since 1998.</p>
  </header>

  <!-- Main Coherence Gauge -->
  <section class="gauge-section animate-in">
    <div class="card gauge-main" id="gauge-card">
      <div class="card-label">Network Coherence Level</div>
      <div class="gauge-ring">
        <svg viewBox="0 0 220 220">
          <circle class="gauge-track" cx="110" cy="110" r="100"/>
          <circle class="gauge-fill" id="gauge-arc" cx="110" cy="110" r="100"/>
        </svg>
        <div class="gauge-center">
          <div class="gauge-value" id="gauge-value">—</div>
          <div class="gauge-unit">NETWORK VARIANCE</div>
        </div>
      </div>
      <div class="gauge-status" id="gauge-status">Loading...</div>
      <div class="gauge-description" id="gauge-desc">Connecting to data feed...</div>
      <div class="gauge-updated" id="gauge-time"></div>
    </div>
  </section>

  <!-- Stats Row -->
  <section class="stats-row animate-in delay-1">
    <div class="card stat-card">
      <div class="stat-value" id="stat-eggs" style="color:var(--accent-cyan)">—</div>
      <div class="stat-label">Active Generators</div>
    </div>
    <div class="card stat-card">
      <div class="stat-value" id="stat-z" style="color:var(--accent-green)">—</div>
      <div class="stat-label">Stouffer Z-Score</div>
    </div>
    <div class="card stat-card">
      <div class="stat-value" id="stat-variance" style="color:var(--accent-amber)">—</div>
      <div class="stat-label">Network Variance</div>
    </div>
    <div class="card stat-card">
      <div class="stat-value" id="stat-countries" style="color:var(--accent-purple)">—</div>
      <div class="stat-label">Countries</div>
    </div>
  </section>

  <!-- 24h Timeline -->
  <section class="timeline-section animate-in delay-2">
    <div class="card">
      <div class="card-label">24-Hour Timeline</div>
      <h2 class="section-title">Network Variance Over Time</h2>
      <p class="section-subtitle">Cumulative deviation from expected randomness across the EGG network</p>
      <div class="chart-container">
        <canvas id="timeline-chart"></canvas>
      </div>
      <div class="chart-legend">
        <span><span class="legend-dot" style="background:var(--accent-green)"></span> Network Variance</span>
        <span><span class="legend-dot" style="background:rgba(251,191,36,0.4)"></span> ±2σ Significance</span>
        <span><span class="legend-dot" style="background:rgba(248,113,113,0.3)"></span> ±3σ High Significance</span>
      </div>
    </div>
  </section>

  <!-- World Map -->
  <section class="map-section animate-in delay-3">
    <div class="card">
      <div class="card-label">Global Network</div>
      <h2 class="section-title">EGG Locations Worldwide</h2>
      <p class="section-subtitle">Each dot represents a hardware random number generator. Color indicates current deviation level.</p>
      <div class="map-container" id="map-container">
        <div class="egg-tooltip" id="egg-tooltip">
          <div class="tt-name"></div>
          <div class="tt-stat"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Notable Events -->
  <section class="events-section animate-in delay-4">
    <div class="card">
      <div class="card-label">Historical Analysis</div>
      <h2 class="section-title">Notable Events & Correlations</h2>
      <p class="section-subtitle">Major world events where the GCP network showed significant deviations from expected randomness</p>
      <div class="events-grid" id="events-grid"></div>
    </div>
  </section>

  <!-- Explainer -->
  <section class="explainer-section">
    <div class="card">
      <div class="card-label">Understanding the Data</div>
      <h2 class="section-title">How It Works</h2>
      <div class="explainer-grid">
        <div class="explainer-card">
          <h3>The Network</h3>
          <p>The Global Consciousness Project maintains ~65 hardware random number generators (called "eggs") around the world. Each egg produces 200 random bits every second using quantum tunneling — a process that should be completely unpredictable.</p>
        </div>
        <div class="explainer-card">
          <h3>The Hypothesis</h3>
          <p>The GCP hypothesizes that during events engaging mass human attention — disasters, celebrations, meditations — the network's random output becomes slightly less random. Over 25+ years and 500+ events tested, the cumulative odds against chance are reported as greater than a trillion to one.</p>
        </div>
        <div class="explainer-card">
          <h3>Network Variance</h3>
          <p>The Stouffer Z-score combines all eggs into one measure. When variance exceeds 1.0, the network shows more structure than expected. Values above ±2σ are considered statistically notable. The colored gauge reflects real-time coherence.</p>
        </div>
        <div class="explainer-card">
          <h3>Skeptical Perspective</h3>
          <p>Critics note potential issues with how events are selected and data interpreted. The effect sizes are very small, and the statistical methods have been questioned by several researchers. This data is presented for exploration, not as proven science.</p>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-links">
      <a href="https://global-mind.org/" target="_blank">Global Consciousness Project</a>
      <a href="https://noosphere.princeton.edu/" target="_blank">Princeton Noosphere</a>
      <a href="https://gcp2.net/" target="_blank">GCP 2.0 (HeartMath)</a>
      <a href="https://gcpdot.com/" target="_blank">GCP Dot</a>
    </div>
    <p>Data source: Global Consciousness Project, Princeton. Updated every 10 minutes.</p>
    <p style="margin-top:8px">This is an independent visualization — not affiliated with Princeton University or the GCP.</p>
    <a class="sister-link" href="#" title="Schumann Resonance Live Monitor">⚡ Sister site: Live Schumann Resonance →</a>
  </footer>
</div>

<!-- Chart.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
// ======================================================
// CONFIG
// ======================================================
const DATA_URL = 'data/gcp-current.json';
const REFRESH_INTERVAL = 600000; // 10 minutes
const CIRCUMFERENCE = 2 * Math.PI * 100; // gauge circle

// ======================================================
// STATUS THRESHOLDS
// ======================================================
function getStatus(variance) {
  if (variance >= 1.3) return { label: 'Very High Coherence', cls: 'status-very-high', color: '#f87171', desc: 'The network is showing strong deviation from randomness. This level of coherence is rare and often correlates with major world events engaging mass attention.' };
  if (variance >= 1.15) return { label: 'High Coherence', cls: 'status-high', color: '#fbbf24', desc: 'Network variance is notably elevated. The random number generators are showing more structure than expected by chance.' };
  if (variance >= 1.05) return { label: 'Elevated Coherence', cls: 'status-elevated', color: '#34d399', desc: 'Slight elevation above baseline. The network is showing a mild trend toward non-random behavior.' };
  return { label: 'Normal — Baseline', cls: 'status-normal', color: '#60a5fa', desc: 'The network is operating within expected random parameters. No significant deviation detected.' };
}

function getEggColor(zSq) {
  if (zSq >= 2.0) return '#f87171';
  if (zSq >= 1.5) return '#fbbf24';
  if (zSq >= 1.0) return '#34d399';
  return '#60a5fa';
}

// ======================================================
// GAUGE UPDATE
// ======================================================
function updateGauge(data) {
  const net = data.network;
  const status = getStatus(net.network_variance);
  
  // Arc
  const pct = Math.min(net.network_variance / 2.0, 1); // 2.0 = full scale
  const offset = CIRCUMFERENCE * (1 - pct);
  const arc = document.getElementById('gauge-arc');
  arc.style.strokeDasharray = CIRCUMFERENCE;
  arc.style.strokeDashoffset = offset;
  arc.style.stroke = status.color;
  
  // Value
  document.getElementById('gauge-value').textContent = net.network_variance.toFixed(2);
  document.getElementById('gauge-value').style.color = status.color;
  
  // Status text
  const statusEl = document.getElementById('gauge-status');
  statusEl.textContent = status.label;
  statusEl.className = 'gauge-status ' + status.cls;
  
  document.getElementById('gauge-desc').textContent = status.desc;
  
  // Time
  const d = new Date(data.updated_at);
  document.getElementById('gauge-time').textContent = 
    'Last updated: ' + d.toLocaleString() + ' (updates every ~10 min)';
}

// ======================================================
// STATS
// ======================================================
function updateStats(data) {
  const net = data.network;
  document.getElementById('stat-eggs').textContent = net.active_eggs + '/' + net.total_eggs;
  document.getElementById('stat-z').textContent = net.stouffer_z.toFixed(2);
  document.getElementById('stat-variance').textContent = net.network_variance.toFixed(3);
  
  const countries = [...new Set(data.eggs.map(e => e.country))].length;
  document.getElementById('stat-countries').textContent = countries;
}

// ======================================================
// TIMELINE CHART
// ======================================================
let chart = null;
function updateTimeline(data) {
  const ctx = document.getElementById('timeline-chart').getContext('2d');
  
  const labels = data.timeline_24h.map(p => {
    const d = new Date(p.time);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  });
  const values = data.timeline_24h.map(p => p.variance);
  
  if (chart) chart.destroy();
  
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: values,
        borderColor: '#34d399',
        backgroundColor: 'rgba(52,211,153,0.08)',
        borderWidth: 2,
        fill: true,
        tension: 0.35,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: '#34d399',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117',
          borderColor: '#1b2332',
          borderWidth: 1,
          titleFont: { family: 'Space Mono', size: 11 },
          bodyFont: { family: 'DM Sans', size: 12 },
          padding: 10,
          callbacks: {
            label: ctx => 'Variance: ' + ctx.parsed.y.toFixed(3)
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(27,35,50,0.5)', drawBorder: false },
          ticks: { color: '#4a5568', font: { family: 'Space Mono', size: 10 }, maxTicksLimit: 12 }
        },
        y: {
          grid: { color: 'rgba(27,35,50,0.5)', drawBorder: false },
          ticks: { color: '#4a5568', font: { family: 'Space Mono', size: 10 } },
          suggestedMin: 0.8,
          suggestedMax: 1.5
        }
      }
    },
    plugins: [{
      // Draw significance bands
      beforeDraw(chart) {
        const { ctx, chartArea: { left, right }, scales: { y } } = chart;
        
        // ±2σ band (amber)
        const y2Top = y.getPixelForValue(1.25);
        const y2Bot = y.getPixelForValue(0.75);
        ctx.fillStyle = 'rgba(251,191,36,0.04)';
        ctx.fillRect(left, y2Top, right - left, y2Bot - y2Top);
        
        // ±3σ band (red)  
        const y3Top = y.getPixelForValue(1.4);
        const y3Bot = y.getPixelForValue(0.6);
        ctx.fillStyle = 'rgba(248,113,113,0.03)';
        ctx.fillRect(left, y3Top, right - left, y2Top - y3Top);
        ctx.fillRect(left, y2Bot, right - left, y3Bot - y2Bot);
        
        // Baseline at 1.0
        const yBase = y.getPixelForValue(1.0);
        ctx.strokeStyle = 'rgba(96,165,250,0.2)';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(left, yBase);
        ctx.lineTo(right, yBase);
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }]
  });
}

// ======================================================
// WORLD MAP (Simple equirectangular SVG)
// ======================================================
function updateMap(data) {
  const container = document.getElementById('map-container');
  const tooltip = document.getElementById('egg-tooltip');
  const w = container.clientWidth;
  const h = container.clientHeight;
  
  // Create SVG
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.style.position = 'absolute';
  svg.style.inset = '0';
  
  // Draw simplified world outline (grid lines for reference)
  const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  gridGroup.setAttribute('opacity', '0.15');
  
  // Latitude lines
  for (let lat = -60; lat <= 80; lat += 30) {
    const y = latToY(lat, h);
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', 0); line.setAttribute('y1', y);
    line.setAttribute('x2', w); line.setAttribute('y2', y);
    line.setAttribute('stroke', '#1b2332'); line.setAttribute('stroke-width', '0.5');
    gridGroup.appendChild(line);
  }
  // Longitude lines
  for (let lng = -180; lng <= 180; lng += 30) {
    const x = lngToX(lng, w);
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', x); line.setAttribute('y1', 0);
    line.setAttribute('x2', x); line.setAttribute('y2', h);
    line.setAttribute('stroke', '#1b2332'); line.setAttribute('stroke-width', '0.5');
    gridGroup.appendChild(line);
  }
  svg.appendChild(gridGroup);
  
  // Draw continent outlines (simplified paths)
  const continentGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  continentGroup.setAttribute('fill', 'none');
  continentGroup.setAttribute('stroke', '#1b2332');
  continentGroup.setAttribute('stroke-width', '1');
  drawContinents(continentGroup, w, h);
  svg.appendChild(continentGroup);
  
  // Draw eggs
  const eggGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  data.eggs.forEach(egg => {
    if (egg.status === 'offline') return;
    const x = lngToX(egg.lng, w);
    const y = latToY(egg.lat, h);
    const color = getEggColor(egg.z_sq);
    
    // Glow
    const glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    glow.setAttribute('cx', x); glow.setAttribute('cy', y); glow.setAttribute('r', 8);
    glow.setAttribute('fill', color); glow.setAttribute('opacity', '0.15');
    eggGroup.appendChild(glow);
    
    // Dot
    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', x); dot.setAttribute('cy', y); dot.setAttribute('r', 3);
    dot.setAttribute('fill', color); dot.setAttribute('class', 'egg-dot');
    
    dot.addEventListener('mouseenter', e => {
      tooltip.querySelector('.tt-name').textContent = egg.name + ' (' + egg.country + ')';
      tooltip.querySelector('.tt-stat').textContent = 'Z² = ' + egg.z_sq.toFixed(2);
      tooltip.style.left = (x + 10) + 'px';
      tooltip.style.top = (y - 40) + 'px';
      tooltip.classList.add('visible');
    });
    dot.addEventListener('mouseleave', () => {
      tooltip.classList.remove('visible');
    });
    
    eggGroup.appendChild(dot);
  });
  svg.appendChild(eggGroup);
  
  // Remove old SVG if exists
  const oldSvg = container.querySelector('svg');
  if (oldSvg) oldSvg.remove();
  container.appendChild(svg);
}

function lngToX(lng, w) { return ((lng + 180) / 360) * w; }
function latToY(lat, h) { return ((90 - lat) / 180) * h; }

// Simplified continent outlines as coordinate arrays
function drawContinents(group, w, h) {
  const continents = [
    // North America (very simplified)
    [[-130,55],[-125,60],[-100,65],[-80,60],[-60,50],[-65,45],[-75,35],[-80,25],[-100,20],[-105,25],[-120,35],[-125,48],[-130,55]],
    // South America
    [[-80,10],[-60,5],[-35,-5],[-35,-20],[-40,-23],[-50,-30],[-65,-55],[-75,-45],[-75,-15],[-80,10]],
    // Europe
    [[-10,35],[0,40],[5,45],[10,55],[20,55],[30,60],[30,70],[40,70],[35,55],[25,40],[10,36],[0,36],[-10,35]],
    // Africa
    [[-15,15],[-15,10],[5,5],[10,0],[12,-5],[15,-15],[30,-35],[35,-25],[40,-10],[50,10],[40,15],[35,30],[10,35],[0,30],[-15,15]],
    // Asia (simplified)
    [[30,35],[40,40],[50,40],[60,45],[70,40],[80,30],[90,25],[100,20],[105,15],[110,25],[120,30],[130,35],[140,40],[145,45],[135,55],[120,55],[100,50],[80,50],[70,55],[60,55],[50,50],[40,45],[30,35]],
    // Australia
    [[115,-15],[130,-12],[140,-15],[150,-25],[150,-35],[140,-38],[130,-33],[115,-22],[115,-15]],
  ];
  
  continents.forEach(coords => {
    let d = '';
    coords.forEach((c, i) => {
      const x = lngToX(c[0], w);
      const y = latToY(c[1], h);
      d += (i === 0 ? 'M' : 'L') + x + ',' + y;
    });
    d += 'Z';
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', d);
    path.setAttribute('fill', 'rgba(27,35,50,0.5)');
    group.appendChild(path);
  });
}

// ======================================================
// EVENTS
// ======================================================
function updateEvents(data) {
  const grid = document.getElementById('events-grid');
  grid.innerHTML = '';
  
  data.notable_events.forEach(ev => {
    const status = getStatus(1 + (ev.peak_z / 10)); // rough mapping
    const card = document.createElement('div');
    card.className = 'event-card card';
    card.innerHTML = `
      <div class="event-date">${ev.date}</div>
      <div class="event-content">
        <div class="event-name">${ev.event}</div>
        <div class="event-desc">${ev.description}</div>
        <div class="event-z" style="background:${getEggColor(ev.peak_z)}22;color:${getEggColor(ev.peak_z)}">
          Peak Z = ${ev.peak_z.toFixed(2)}
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

// ======================================================
// MAIN
// ======================================================
async function loadData() {
  try {
    const resp = await fetch(DATA_URL + '?t=' + Date.now());
    const data = await resp.json();
    
    updateGauge(data);
    updateStats(data);
    updateTimeline(data);
    updateMap(data);
    updateEvents(data);
  } catch (err) {
    console.error('Failed to load GCP data:', err);
    document.getElementById('gauge-status').textContent = 'Data unavailable';
    document.getElementById('gauge-desc').textContent = 'Could not connect to data feed. Will retry automatically.';
  }
}

// Initial load
loadData();

// Auto-refresh
setInterval(loadData, REFRESH_INTERVAL);

// Resize map on window resize
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(async () => {
    try {
      const resp = await fetch(DATA_URL + '?t=' + Date.now());
      const data = await resp.json();
      updateMap(data);
    } catch(e) {}
  }, 250);
});
</script>

</body>
</html>
